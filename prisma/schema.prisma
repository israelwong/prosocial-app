generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String?
  email     String?
  password  String
  role      String   @default("user")
  // puesto    String?// added
  telefono  String?
  status    String   @default("inactive")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Sesion    Sesion[]
  Agenda    Agenda[]
  Pago      Pago[]
  Evento    Evento[]
  CotizacionServicio CotizacionServicio[]
  
  // === RELACIONES NOMINA ===
  Nomina              Nomina[]              @relation("NominaUsuario")
  NominaAutorizada    Nomina[]              @relation("AutorizadoPor")
  NominaPagada        Nomina[]              @relation("PagadoPor")
  // Notificacion Notificacion[]
}

model Sesion {
  id        String   @id @default(cuid())
  userId    String
  User      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cliente {
  id        String   @id @default(cuid())
  nombre    String
  email     String?
  telefono  String?  @unique
  direccion String?
  status    String   @default("activo") //prospecto, cliente
  canalId   String?
  Canal     Canal?   @relation(fields: [canalId], references: [id])
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Evento    Evento[]
  Pago      Pago[]
}

model Evento {
  id           String      @id @default(cuid())
  clienteId    String
  Cliente      Cliente     @relation(fields: [clienteId], references: [id])
  eventoTipoId String?
  EventoTipo   EventoTipo? @relation(fields: [eventoTipoId], references: [id])
  nombre       String?     @default("Pendiente")
  fecha_evento DateTime
  sede         String?
  direccion    String?
  status       String      @default("active")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  userId String?
  User   User?   @relation(fields: [userId], references: [id])

  eventoEtapaId String?
  EventoEtapa   EventoEtapa? @relation(fields: [eventoEtapaId], references: [id])

  EventoBitacora EventoBitacora[]
  Cotizacion     Cotizacion[]
  Agenda         Agenda[]
  Nomina         Nomina[]
}

model EventoBitacora {
  id          String   @id @default(cuid())
  eventoId    String
  Evento      Evento   @relation(fields: [eventoId], references: [id])
  comentario  String
  importancia String   @default("1")
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model EventoTipo {
  id         String       @id @default(cuid())
  nombre     String //XV años Boda, Bautizo, Cumpleaños, etc
  posicion   Int          @default(0)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  Evento     Evento[]
  Paquete    Paquete[]
  Cotizacion Cotizacion[]
}

model EventoEtapa {
  id        String   @id @default(cuid())
  nombre    String
  posicion  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Evento    Evento[]
}

model Canal {
  id        String    @id @default(cuid())
  nombre    String
  posicion  Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Cliente   Cliente[]
}

model Pago {
  id                                 String                            @id @default(cuid())
  clienteId                          String? //id del cliente
  Cliente                            Cliente?                          @relation(fields: [clienteId], references: [id])
  cotizacionId                       String?
  Cotizacion                         Cotizacion?                       @relation(fields: [cotizacionId], references: [id], onDelete: SetNull)
  condicionesComercialesId           String?
  CondicionesComerciales             CondicionesComerciales?           @relation(fields: [condicionesComercialesId], references: [id])
  condicionesComercialesMetodoPagoId String?
  CondicionesComercialesMetodoPago   CondicionesComercialesMetodoPago? @relation(fields: [condicionesComercialesMetodoPagoId], references: [id])
  metodoPagoId                       String?
  MetodoPago                         MetodoPago?                       @relation(fields: [metodoPagoId], references: [id])
  metodo_pago                        String
  monto                              Float
  concepto                           String
  descripcion                        String?
  stripe_session_id                  String?                           @unique
  stripe_payment_id                  String?                           @unique
  status                             String                            @default("pending") //pending, succeeded, failed
  createdAt                          DateTime                          @default(now())
  updatedAt                          DateTime                          @updatedAt
  //agregadas
  userId                             String?
  User                               User?                             @relation(fields: [userId], references: [id])
  tipo_transaccion                   String?                           @default("ingreso") //ingreso, egreso
  categoria_transaccion              String?                           @default("abono") //abono, honorarios, servicio, producto, comision, ajuste
}

model Cotizacion {
  id                                 String                             @id @default(cuid())
  eventoTipoId                       String
  EventoTipo                         EventoTipo                         @relation(fields: [eventoTipoId], references: [id])
  eventoId                           String
  Evento                             Evento                             @relation(fields: [eventoId], references: [id])
  
  nombre                             String
  precio                             Float
  descripcion                        String?
  condicionesComercialesId           String?
  CondicionesComerciales             CondicionesComerciales?            @relation(fields: [condicionesComercialesId], references: [id])
  condicionesComercialesMetodoPagoId String?
  CondicionesComercialesMetodoPago   CondicionesComercialesMetodoPago[]
  status                             String                             @default("pending") //pendiente, aprobado, rechazado
  archivada                          Boolean                            @default(false)
  visible_cliente                    Boolean?                           @default(true)
  createdAt                          DateTime                           @default(now())
  updatedAt                          DateTime                           @updatedAt
  expiresAt                          DateTime?                          @default(dbgenerated("now() + interval '10 day'"))
  Servicio                           CotizacionServicio[]
  Costos                             CotizacionCosto[]
  Pago                               Pago[]
  CotizacionVisita                   CotizacionVisita[]
}

model CotizacionServicio {
  id                  String            @id @default(cuid())
  cotizacionId        String
  Cotizacion          Cotizacion        @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  servicioId          String?           // Opcional para servicios personalizados
  Servicio            Servicio?         @relation(fields: [servicioId], references: [id])
  servicioCategoriaId String?           // Opcional para servicios personalizados
  ServicioCategoria   ServicioCategoria? @relation(fields: [servicioCategoriaId], references: [id])

  // --- CAMPOS OPERACIONALES ---
  cantidad            Int               @default(1)
  posicion            Int               @default(0)
  userId              String?
  User                User?             @relation(fields: [userId], references: [id])
  fechaAsignacion     DateTime?
  FechaEntrega        DateTime?
  status              String            @default("pendiente")
  
  // --- CAMPOS SNAPSHOT PARA TRAZABILIDAD ---
  // Jerarquía: Sección → Categoría → Servicio
  seccion_nombre_snapshot    String?           // Nombre de sección al momento de cotizar
  categoria_nombre_snapshot  String?           // Nombre de categoría al momento de cotizar
  nombre_snapshot            String            @default("Servicio migrado") // Nombre del servicio al momento de cotizar
  descripcion_snapshot       String?           // Descripción completa del servicio
  
  // Precios y costos snapshot
  precio_unitario_snapshot   Float             @default(0)
  costo_snapshot             Float             @default(0)
  gasto_snapshot             Float             @default(0)
  utilidad_snapshot          Float             @default(0)
  precio_publico_snapshot    Float             @default(0)
  tipo_utilidad_snapshot     String            @default("servicio") // servicio, producto
  
  // Campos calculados (actuales, no snapshot)
  precioUnitario      Float             @default(0)  // Precio actual para cálculos
  subtotal            Float             @default(0)  // cantidad * precioUnitario
  
  // --- CAMPOS LEGACY TEMPORALES (migrar y eliminar después) ---
  // MANTENER TEMPORALMENTE para migración segura de datos
  nombre              String?           // LEGACY: migrar a nombre_snapshot
  descripcion         String?           // LEGACY: migrar a descripcion_snapshot  
  costo               Float?            @default(0) // LEGACY: migrar a costo_snapshot
  gasto               Float?            @default(0) // LEGACY: migrar a gasto_snapshot
  utilidad            Float?            @default(0) // LEGACY: migrar a utilidad_snapshot
  precio_publico      Float?            @default(0) // LEGACY: migrar a precio_publico_snapshot
  tipo_utilidad       String?           @default("servicio") // LEGACY: migrar a tipo_utilidad_snapshot
  categoria_nombre    String?           // LEGACY: migrar a categoria_nombre_snapshot
  seccion_nombre      String?           // LEGACY: migrar a seccion_nombre_snapshot
  
  // --- CAMPOS PERSONALIZACIÓN ---
  es_personalizado    Boolean           @default(false)     // true si es un servicio agregado al vuelo
  servicio_original_id String?          // ID del servicio original si es personalizado

  // === RELACIÓN CON NÓMINA ===
  NominaServicio      NominaServicio[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

// Nueva tabla para costos adicionales
model CotizacionCosto {
  id            String     @id @default(cuid())
  cotizacionId  String
  Cotizacion    Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  
  nombre        String     // Nombre del costo adicional
  descripcion   String?    // Descripción opcional
  costo         Float      @default(0)
  tipo          String     @default("adicional") // adicional, descuento, impuesto, comision
  posicion      Int        @default(0)
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

model CotizacionVisita {
  id           String     @id @default(cuid())
  cotizacionId String
  Cotizacion   Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
}

model Servicio {
  id                  String               @id @default(cuid())
  servicioCategoriaId String
  ServicioCategoria   ServicioCategoria    @relation(fields: [servicioCategoriaId], references: [id])
  
  // --- CAMPOS PRINCIPALES ---
  nombre              String
  
  // --- CAMPOS FINANCIEROS ---
  costo               Float                @default(0)
  gasto               Float                @default(0)
  utilidad            Float                @default(0)
  precio_publico      Float                @default(0)
  tipo_utilidad       String               @default("servicio") //servicio, producto
  
  // --- CAMPOS OPERACIONALES ---
  posicion            Int                  @default(0)
  status              String               @default("active")
  
  // --- CAMPOS LEGACY (mantener por compatibilidad) ---
  visible_cliente     Boolean              @default(true)  // LEGACY: No se usa, mantener por compatibilidad
  
  // --- METADATOS ---
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  
  // --- RELACIONES ---
  ServicioGasto       ServicioGasto[]
  CotizacionServicio  CotizacionServicio[]
  PaqueteServicio     PaqueteServicio[]
}

model ServicioSeccion {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?
  posicion    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relación: Una Sección está enlazada a muchas entradas de SeccionCategoria
  seccionCategorias SeccionCategoria[]
}


model SeccionCategoria {
  id          String @id @default(cuid())
  seccionId   String
  categoriaId String @unique // ¡Clave! Esto asegura que una categoría solo puede estar en una sección.

  // Relaciones
  Seccion           ServicioSeccion   @relation(fields: [seccionId], references: [id], onDelete: Cascade)
  ServicioCategoria ServicioCategoria @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
}


model ServicioGasto {
  id         String   @id @default(cuid())
  servicioId String
  Servicio   Servicio @relation(fields: [servicioId], references: [id])
  nombre     String
  costo      Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ServicioCategoria {
  id                 String               @id @default(cuid())
  nombre             String               @unique //Fotografia, Video, Entregable, etc
  posicion           Int                  @default(0)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  seccionCategoria  SeccionCategoria? 
  Servicio           Servicio[]
  PaqueteServicio    PaqueteServicio[]
  CotizacionServicio CotizacionServicio[]
}

model Paquete {
  id              String            @id @default(cuid())
  eventoTipoId    String
  EventoTipo      EventoTipo        @relation(fields: [eventoTipoId], references: [id])
  nombre          String
  costo           Float?
  gasto           Float?
  utilidad        Float?
  precio          Float?
  status          String            @default("active")
  posicion        Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  PaqueteServicio PaqueteServicio[]
}

model PaqueteServicio {
  id                  String            @id @default(cuid())
  paqueteId           String
  Paquete             Paquete           @relation(fields: [paqueteId], references: [id], onDelete: Cascade)
  servicioId          String
  Servicio            Servicio          @relation(fields: [servicioId], references: [id])
  servicioCategoriaId String
  ServicioCategoria   ServicioCategoria @relation(fields: [servicioCategoriaId], references: [id])
  cantidad            Int               @default(1)
  posicion            Int               @default(0)
  visible_cliente     Boolean           @default(true)
  status              String            @default("active")
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model Configuracion {
  id                          String   @id @default(cuid())
  nombre                      String
  utilidad_servicio           Float
  utilidad_producto           Float
  comision_venta              Float
  sobreprecio                 Float
  claveAutorizacion           String? //!added
  numeroMaximoServiciosPorDia Int? //!added
  status                      String   @default("active")
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
}

model MetodoPago {
  id                               String                             @id @default(cuid())
  metodo_pago                      String //efectivo, tarjeta de crédito, tarjeta de debito, transferencia interbancaria, oxxo
  comision_porcentaje_base         Float?                             @map("comision_porcentaje_base") //3.6
  comision_fija_monto              Float? //3
  num_msi                          Int? // 3, 6, 9, 12
  comision_msi_porcentaje          Float?
  orden                            Int?                               @default(0)
  payment_method                   String?                            @default("card")
  status                           String                             @default("active")
  createdAt                        DateTime                           @default(now())
  updatedAt                        DateTime                           @updatedAt
  CondicionesComercialesMetodoPago CondicionesComercialesMetodoPago[]
  Pago                             Pago[]
}

model CondicionesComerciales {
  id                               String                             @id @default(cuid())
  nombre                           String // 3/6/9/12 msi / 10% de desc plan estandar (30% anticipo / 70 en exibiciones) 
  descripcion                      String?
  descuento                        Float? // 10
  porcentaje_anticipo              Float?                             @default(0) // 30
  status                           String                             @default("active")
  orden                            Int?                               @default(0)
  // tipoEvento                       String? //! social / empresarial
  createdAt                        DateTime                           @default(now())
  updatedAt                        DateTime                           @updatedAt
  CondicionesComercialesMetodoPago CondicionesComercialesMetodoPago[] 
  Cotizacion                       Cotizacion[]
  Pago                             Pago[]
}

model CondicionesComercialesMetodoPago {
  id                       String                 @id @default(cuid())
  condicionesComercialesId String
  CondicionesComerciales   CondicionesComerciales @relation(fields: [condicionesComercialesId], references: [id], onDelete: Cascade) 
  metodoPagoId             String
  MetodoPago               MetodoPago             @relation(fields: [metodoPagoId], references: [id])
  orden                    Int?                   @default(0)
  status                   String                 @default("active")
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  Cotizacion               Cotizacion[]
  Pago                     Pago[]
}

//Anuncio
model Campania {
  id        String    @id @default(cuid())
  nombre    String
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Anuncio   Anuncio[]
}

model AnuncioPlataforma {
  id        String    @id @default(cuid())
  nombre    String //facebook, instagram, google, youtube, impreso
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Anuncio   Anuncio[]
}

model AnuncioTipo {
  id        String    @id @default(cuid())
  nombre    String //imagen, video, carousel
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  anuncio   Anuncio[]
}

model AnuncioCategoria {
  id        String    @id @default(cuid())
  nombre    String //banner, video, carousel
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  anuncio   Anuncio[]
}

model Anuncio {
  id                  String            @id @default(cuid())
  campaniaId          String
  Campania            Campania          @relation(fields: [campaniaId], references: [id])
  nombre              String
  anuncioTipoId       String
  AnuncioTipo         AnuncioTipo       @relation(fields: [anuncioTipoId], references: [id])
  anuncioCategoriaId  String
  AnuncioCategoria    AnuncioCategoria  @relation(fields: [anuncioCategoriaId], references: [id])
  anuncioPlataformaId String
  AnuncioPlataforma   AnuncioPlataforma @relation(fields: [anuncioPlataformaId], references: [id])
  imagen_url          String
  status              String            @default("active")
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model AnuncioVisita {
  id        String   @id @default(cuid())
  anuncioId String
  fecha     DateTime
  createdAt DateTime @default(now())
}

model Agenda {
  id            String    @id @default(cuid())
  userId        String?
  User          User?     @relation(fields: [userId], references: [id])
  eventoId      String
  Evento        Evento    @relation(fields: [eventoId], references: [id])
  concepto      String?
  descripcion   String?
  googleMapsUrl String?
  direccion     String?
  fecha         DateTime?
  hora          String?
  status        String    @default("pendiente")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  agendaTipo    String?
}

model AgendaTipo {
  id        String   @id @default(cuid())
  nombre    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notificacion {
  id           String   @id @default(cuid())
  userId       String?
  titulo       String
  mensaje      String
  status       String   @default("active")
  cotizacionId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ========================================
// MODELOS PARA SISTEMA DE NOMINA
// ========================================

model Nomina {
  id                    String                @id @default(cuid())
  
  // === RELACIONES PRINCIPALES ===
  userId                String
  User                  User                  @relation("NominaUsuario", fields: [userId], references: [id])
  eventoId              String?               // Para reportes por evento
  Evento                Evento?               @relation(fields: [eventoId], references: [id])
  
  // === INFORMACIÓN DEL PAGO ===
  concepto              String                // Ej: "Fotografía Boda María", "Servicio múltiple Evento X"
  descripcion           String?               // Detalle adicional
  monto_bruto           Float                 // Monto antes de deducciones
  deducciones           Float                 @default(0) // ISR, retenciones, etc.
  monto_neto            Float                 // Monto final a pagar
  
  // === AGRUPACIÓN DE SERVICIOS ===
  tipo_pago             String                @default("individual") // "individual", "agrupado", "comision"
  servicios_incluidos   Int                   @default(1) // Cantidad de servicios
  
  // === CONTROL DE FECHAS ===
  fecha_asignacion      DateTime              @default(now())
  fecha_autorizacion    DateTime?             // Cuando se autoriza el pago
  fecha_pago            DateTime?             // Cuando se efectúa el pago
  periodo_inicio        DateTime?             // Para pagos por periodo
  periodo_fin           DateTime?
  
  // === STATUS Y CONTROL ===
  status                String                @default("pendiente") // pendiente, autorizado, pagado, cancelado
  autorizado_por        String?               // userId de quien autoriza
  AutorizadoPor         User?                 @relation("AutorizadoPor", fields: [autorizado_por], references: [id])
  pagado_por            String?               // userId de quien ejecuta el pago
  PagadoPor             User?                 @relation("PagadoPor", fields: [pagado_por], references: [id])
  metodo_pago           String?               @default("transferencia") // transferencia, efectivo, cheque
  
  // === TRAZABILIDAD FINANCIERA ===
  // Snapshots para reportes y auditoría
  costo_total_snapshot  Float                 @default(0) // Suma de costos de servicios
  gasto_total_snapshot  Float                 @default(0) // Suma de gastos de servicios
  comision_porcentaje   Float?                // Si es pago por comisión
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // === RELACIONES CON SERVICIOS ===
  NominaServicio        NominaServicio[]
}

// Tabla intermedia para relacionar nómina con servicios específicos
model NominaServicio {
  id                    String                @id @default(cuid())
  nominaId              String
  Nomina                Nomina                @relation(fields: [nominaId], references: [id], onDelete: Cascade)
  cotizacionServicioId  String?
  CotizacionServicio    CotizacionServicio?   @relation(fields: [cotizacionServicioId], references: [id], onDelete: SetNull)
  
  // === SNAPSHOT DEL SERVICIO AL MOMENTO DEL PAGO ===
  servicio_nombre       String                // Snapshot del nombre
  seccion_nombre        String?               // Snapshot de la sección
  categoria_nombre      String?               // Snapshot de la categoría
  costo_asignado        Float                 // Costo específico para este pago
  cantidad_asignada     Int                   @default(1)
  
  createdAt             DateTime              @default(now())
  
  @@unique([nominaId, cotizacionServicioId]) // Un servicio solo puede estar en una nómina
}

